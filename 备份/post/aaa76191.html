<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script></script><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3"><link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222"><meta name="keywords" content="Python,专题笔记,装饰器,"><link rel="alternate" href="/atom.xml" title="mtianyan's blog" type="application/atom+xml"><meta name="description" content="学会装饰器，Python更进阶    函数作用域到闭包到装饰器讲解，及闭包和装饰器的运用。  [√] 慕课网Meshare_huang老师: python进阶"><meta name="keywords" content="Python,专题笔记,装饰器"><meta property="og:type" content="article"><meta property="og:title" content="Python装饰器-专题笔记"><meta property="og:url" content="http://blog.mtianyan.cn/post/aaa76191.html"><meta property="og:site_name" content="mtianyan&#39;s blog"><meta property="og:description" content="学会装饰器，Python更进阶    函数作用域到闭包到装饰器讲解，及闭包和装饰器的运用。  [√] 慕课网Meshare_huang老师: python进阶"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180104/J8Gm6gi9BF.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180105/g5IG6mbE7m.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180105/7DEIlh1eli.png?imageslim"><meta property="og:updated_time" content="2018-02-02T12:40:13.956Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Python装饰器-专题笔记"><meta name="twitter:description" content="学会装饰器，Python更进阶    函数作用域到闭包到装饰器讲解，及闭包和装饰器的运用。  [√] 慕课网Meshare_huang老师: python进阶"><meta name="twitter:image" content="http://myphoto.mtianyan.cn/blog/180104/J8Gm6gi9BF.png?imageslim"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://blog.mtianyan.cn/post/aaa76191.html"><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement("script"),n=t.getElementsByTagName("script")[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,0,("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"e28768be"}),daovoice("update")</script><title>Python装饰器-专题笔记 | mtianyan's blog</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?415372bd35fec36f7558dd96b48ec03f";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/mtianyan" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">mtianyan's blog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">天涯明月笙的博客小站(Github托管)</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br> 公益404</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://blog.mtianyan.cn/post/aaa76191.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="mtianyan"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="mtianyan's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Python装饰器-专题笔记</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-04T16:41:46+08:00">2018-01-04</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python从入门到精通/" itemprop="url" rel="index"><span itemprop="name">python从入门到精通</span></a></span></span> <span id="/post/aaa76191.html" class="leancloud_visitors" data-flag-title="Python装饰器-专题笔记"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">热度&#58;</span><span class="leancloud-visitors-count"></span> <span>℃</span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">3,590</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">16</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote class="blockquote-center"><p>学会装饰器，Python更进阶</p></blockquote><div class="note"><p> 函数作用域到闭包到装饰器讲解，及闭包和装饰器的运用。</p><ul><li>[√] 慕课网Meshare_huang老师: python进阶</li></ul></div><a id="more"></a><p><img src="http://myphoto.mtianyan.cn/blog/180104/J8Gm6gi9BF.png?imageslim" alt="mark"></p><h1 id="函数作用域"><a href="#函数作用域" class="headerlink" title="函数作用域"></a>函数作用域</h1><p>介绍 Python 的函数作用域，了解函数作用域 <code>LEGB</code> 间关系。</p><p>主要内容:</p><ul><li>函数作用域LEGB</li><li>闭包理解与使用</li><li>装饰器</li></ul><p><code>LEGB</code>: <code>L&gt;E&gt;G&gt;B</code></p><ul><li><code>L: local</code> 函数内部作用域</li><li><code>E: enclosing</code> 函数内部与内嵌函数之间(主要是内置函数对我们函数变量的一个引用，称之为闭包)</li><li><code>G: global</code> 全局作用域: 我们所定义的全局变量。</li><li><code>B: build-in</code> 内置作用域: Python解释器默认导入的一些变量。</li></ul><p><code>build-in</code>比如：<code>tuple</code>，<code>list</code>，<code>元组</code>等。</p><p>知识点： <code>LEGB</code>原则: 首先从<code>函数内部作用域</code>查找，然后去<code>enclosing作用域</code>中去查找,然后依次是<code>全局</code> 和<code>内置</code>。</p><p>例子(使用Python3.4版本 + sublimeText)：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">passline = <span class="number">60</span>          <span class="comment">#passline 是全局变量（global）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(val)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> val &gt;= passline:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'pass'</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'failed'</span>)</span><br><span class="line"></span><br><span class="line">func(<span class="number">89</span>)</span><br></pre></td></tr></table></figure><p>运行结果:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pass</span><br></pre></td></tr></table></figure><p>分析：</p><ul><li>当我们定义一个函数时，会引入一个作用域：<code>L: local</code>.</li><li>当我们对于<code>func</code>函数进行调用时，<code>val</code>就是我们的一个本地变量。</li><li>在函数内部并没有定义<code>passline</code> 的值。这个时候回去全局变量找查找。如果全局没有还会继续向上查找<code>B: build-in</code></li></ul><p>当总分变为150.我们的<code>passline</code>应该设为<code>90</code>,如果我们不想修改全局的<code>passline</code>,<br>我们可以在函数内部定义新的passline。因为<code>L&gt;G</code>,所以会以我们自己函数内部的<code>local</code>域为准。</p><p>实现代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">passline = <span class="number">60</span>          <span class="comment">#passline 是全局变量（global）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(val)</span>:</span></span><br><span class="line">	passline = <span class="number">90</span>      <span class="comment">#这里的passline是函数内部作用域(local)</span></span><br><span class="line">	<span class="keyword">if</span> val &gt;= passline:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'pass'</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'failed'</span>)</span><br><span class="line"></span><br><span class="line">func(<span class="number">89</span>)</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed</span><br></pre></td></tr></table></figure><p>Python解释器查找顺序为<code>L--&gt;E--&gt;G--&gt;B</code>,如果已经找到，就不会找更上层。</p><p>如果我们需要拿到两个分数中的更大值。</p><p>实现代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Max</span><span class="params">(val1,val2)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> max(val1,val2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> (Max(<span class="number">90</span>,<span class="number">100</span>))</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100</span><br></pre></td></tr></table></figure><p><code>Max</code>函数内部引用了一个内置函数方法<code>max</code>.这个内置方法在<code>Max</code>函数中以及整个文件中都没有定义。</p><p>这个<code>max</code>存在于我们的<code>build-in</code>.Python解释器在运行时会自动导入内置的方法。比如<code>list,tuple</code></p><p>函数内部的函数产生<code>enclosing</code>：</p><p>实现代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">passline = <span class="number">60</span>          <span class="comment">#passline 是全局变量（global）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(val)</span>:</span></span><br><span class="line">	passline = <span class="number">90</span>      <span class="comment">#这里的passline是函数内部作用域(local)</span></span><br><span class="line">	<span class="keyword">if</span> val &gt;= passline:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'pass'</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'failed'</span>)</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">in_func</span><span class="params">()</span>:</span></span><br><span class="line">		<span class="keyword">print</span> (val)</span><br><span class="line">	<span class="comment"># 调用方式1</span></span><br><span class="line">	in_func()</span><br><span class="line">	<span class="comment"># 调用方式2：将in_func()返回。这样我们就可以在外部调用。</span></span><br><span class="line">func(<span class="number">89</span>)</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">failed</span><br><span class="line">89</span><br></pre></td></tr></table></figure><p><code>val</code>变量的查找过程: <code>print (val)</code> 中val的查找过程。</p><ul><li><code>in_func()</code>内部并没有定义这个<code>val</code>的值。也就是<code>local作用域</code>中没有这个值.</li><li>下一步我们就会去<code>enclosing</code>作用域查找。也就是我们的<code>func(val)</code>中引入的有val变量。</li><li>找到传入的<code>val</code>值<code>89</code></li></ul><h1 id="什么是闭包"><a href="#什么是闭包" class="headerlink" title="什么是闭包"></a>什么是闭包</h1><p>介绍什么是闭包，为什么使用闭包，闭包作用</p><h2 id="装饰器之闭包1"><a href="#装饰器之闭包1" class="headerlink" title="装饰器之闭包1"></a>装饰器之闭包1</h2><p><code>closure</code>：内部函数对<code>enclosig</code>作用域的变量进行引用</p><blockquote><p>概念：如果在一个内部函数里，对在<code>外部作用域（但不是在全局作用域）</code>也就是<code>enclosig</code>作用域的变量进行引用，那么内部函数就被认为是<code>闭包（closure）</code></p></blockquote><p>函数实质与属性</p><ul><li>函数是一个对象</li><li>函数执行完之后内部变量回收(如果我们中间产生一个变量，这个变量返回那么他不会被回收: 因为他的引用计数还补为0)</li><li>作为一个对象函数拥有自己的属性(闭包函数的特殊属性)</li><li>函数返回值</li></ul><p>正常的调用参考上一章代码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">passline = <span class="number">60</span>          <span class="comment">#passline 是全局变量（global）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(val)</span>:</span></span><br><span class="line">	passline = <span class="number">90</span>     </span><br><span class="line">	<span class="keyword">if</span> val &gt;= passline:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'pass'</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'failed'</span>)</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">in_func</span><span class="params">()</span>:</span></span><br><span class="line">		<span class="keyword">print</span> (val)</span><br><span class="line">	in_func()	</span><br><span class="line">	<span class="keyword">return</span> in_func <span class="comment"># in_func是func内部的一个函数对象。</span></span><br><span class="line">f = func(<span class="number">89</span>) <span class="comment">#使用f来接收返回值</span></span><br><span class="line">f() <span class="comment">#infunc</span></span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">failed</span><br><span class="line">89</span><br><span class="line">89</span><br></pre></td></tr></table></figure><p><code>func</code>执行完成之后，他的<code>val</code>值就会消失。但是我们再次调用<code>f()</code><br>因为<code>infunc</code>的引用计数还没有归零。所以会一直保留。</p><ul><li>当我们这时候运行<code>f()</code>，<code>val</code>值是哪来的呢？</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> (f.__closure__)</span><br></pre></td></tr></table></figure><p>运行结果<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&lt;cell at 0x0000000005236C48: int object at 0x00000000052169F8&gt;,)</span><br></pre></td></tr></table></figure><p></p><p>这里面有一个<code>int object</code> 地址为: <code>0x00000000052169F8</code></p><p>添加一行查看<code>传入func</code>的<code>val</code>的<code>id</code>值(<code>%x</code> 表示使用<code>16进制</code>打印。<code>id()</code>可打印出<code>val</code>的<code>id</code>)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def func(val):</span><br><span class="line">	print (&apos;%x&apos;%id(val))</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180105/g5IG6mbE7m.png?imageslim" alt="mark"></p><p>可以看出<code>value</code>的<code>id</code>值和<code>__closure__</code>中的那个<code>int object</code>的值一样。</p><p>如果我引用了外部<code>enclosing</code>的值。会将该值保存在<code>函数的属性</code>中。<br>当我们调用<code>f()</code>时并没有去代码中查找。而是去函数的属性(<code>Local域</code>)中查找.</p><p>可以理解为在<code>in_func</code>定义的时候，函数属性中会添加<code>(val,)</code><br>这个属性的值是一个元组。是不能变得。</p><p>总分从<code>100</code>到<code>150</code>涉及到passline的取值问题。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">passline = <span class="number">60</span>  <span class="comment">#100      </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(val)</span>:</span></span><br><span class="line">	passline = <span class="number">90</span> <span class="comment"># 150</span></span><br></pre></td></tr></table></figure><p>最常用的解决方案是定义两个函数分别处理:</p><p>实现代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_150</span><span class="params">(val)</span>:</span></span><br><span class="line">	passline = <span class="number">90</span> <span class="comment"># 150    </span></span><br><span class="line">	<span class="keyword">if</span> val &gt;= passline:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'pass'</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'failed'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_100</span><span class="params">(val)</span>:</span></span><br><span class="line">	passline = <span class="number">60</span> <span class="comment"># 150    </span></span><br><span class="line">	<span class="keyword">if</span> val &gt;= passline:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'pass'</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'failed'</span>)</span><br><span class="line">func_100(<span class="number">89</span>) </span><br><span class="line">func_150(<span class="number">89</span>)</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pass</span><br><span class="line">failed</span><br></pre></td></tr></table></figure><p>上面两个函数在处理逻辑上基本一致，如果后期对于打印出来的信息要做修改，就得修改两遍。</p><p>如要为print添加数值的显示。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_150</span><span class="params">(val)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'%d pass'</span> %val)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_100</span><span class="params">(val)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'%d pass'</span> %val)</span><br></pre></td></tr></table></figure><p>所有的改动都得做两遍。（这里想起了c++的模板）</p><p>进阶版修改:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">set_passline</span><span class="params">(passline)</span>:</span> <span class="comment">#passline = 60</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">cmp</span><span class="params">(val)</span>:</span> <span class="comment">#cmp 的__closure__属性中加入passline</span></span><br><span class="line">		<span class="keyword">if</span> val &gt;= passline:</span><br><span class="line">			<span class="keyword">print</span> (<span class="string">'%x'</span>%id(passline))</span><br><span class="line">			<span class="keyword">print</span> (<span class="string">'pass'</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">print</span> (<span class="string">'%x'</span>%id(passline))</span><br><span class="line">			<span class="keyword">print</span> (<span class="string">'failed'</span>)</span><br><span class="line">	<span class="keyword">return</span> cmp</span><br><span class="line"></span><br><span class="line">f_100 = set_passline(<span class="number">60</span>)</span><br><span class="line">f_150 = set_passline(<span class="number">90</span>)</span><br><span class="line"><span class="keyword">print</span> (type(f_100)) <span class="comment"># f_100就是一个函数对象。__closure__属性中存放着passline</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> (f_100.__closure__)</span><br><span class="line">f_100(<span class="number">89</span>)</span><br><span class="line"><span class="keyword">print</span> (f_150.__closure__)</span><br><span class="line">f_150(<span class="number">89</span>)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180105/7DEIlh1eli.png?imageslim" alt="mark"></p><p>理解：闭包就是<code>内部函数(cmp)</code>对于<code>外层函数(set_passline)</code>变量(<code>passline</code>)的使用（也就是对<code>enclosing作用域变量</code>的使用），会将我们使用的这个变量(<code>passline</code>)放到我们的<code>__closure__</code>这个属性中。当我们内部函数处理时会直接对于这个属性值进行使用。</p><p>闭包的作用：</p><ul><li>封装</li><li>代码复用</li></ul><h2 id="装饰器之闭包2"><a href="#装饰器之闭包2" class="headerlink" title="装饰器之闭包2"></a>装饰器之闭包2</h2><p>上节我们接触到的<code>enclosing域</code>中的变量<code>passline</code>是一个整数，我们可不可以把它换成一个函数对象呢。</p><p>废话，当然可以。</p><p>例子： 求一组数据的总分和平均分</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_sum</span><span class="params">(*arg)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_average</span><span class="params">(*arg)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(arg) / len(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(my_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">print(my_average(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">15</span><br><span class="line">3</span><br></pre></td></tr></table></figure><ul><li>此时如果我们的<code>my_average</code>需要加上一个对于传入参数不为0的判断。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(my_average())</span><br></pre></td></tr></table></figure><p>因为传入为空会报<code>除0</code>错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZeroDivisionError: integer division or modulo by zero</span><br></pre></td></tr></table></figure><ul><li>而我们如果想要给<code>my_sum</code>传一个字符串进去。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(my_sum(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="string">'6'</span>))</span><br></pre></td></tr></table></figure><p>会报错不支持<code>int</code>和<code>str</code>相加:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: unsupported operand type(s) for +: &apos;int&apos; and &apos;str&apos;</span><br></pre></td></tr></table></figure><p>说明我们的函数写的不够健全。我们还需要对于函数的参数进行判断。</p><ol><li>判断参数有没有长度。也就是不能为空。</li><li>对于参数的类型进行判断，限制为只是<code>int型</code></li></ol><p>普通版实现代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_sum</span><span class="params">(*arg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(arg) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> val <span class="keyword">in</span> arg:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> isinstance(val, int):</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> sum(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_average</span><span class="params">(*arg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(arg) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> val <span class="keyword">in</span> arg:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> isinstance(val, int):</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> sum(arg) / len(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(my_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">print(my_average(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">print(my_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">'6'</span>))</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">None</span><br><span class="line">3</span><br><span class="line">None</span><br></pre></td></tr></table></figure><p>可以看出两部分代码都有重合，我们使用进阶方法，使用闭包方式完成。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_sum</span><span class="params">(*arg)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'in mysum arg='</span>, arg)</span><br><span class="line">    <span class="keyword">return</span> sum(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_average</span><span class="params">(*arg)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'in my_average arg='</span>, arg)</span><br><span class="line">    <span class="keyword">return</span> sum(arg) / len(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">in_dec</span><span class="params">(*arg)</span>:</span>  <span class="comment"># my_sum -&gt; __closure__</span></span><br><span class="line">        <span class="keyword">print</span> (<span class="string">'in dec arg='</span>, arg)</span><br><span class="line">        <span class="keyword">if</span> len(arg) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> val <span class="keyword">in</span> arg:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> isinstance(val, int):</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> func(*arg)</span><br><span class="line">    <span class="keyword">return</span> in_dec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># dec() return indec -&gt; my_sum;</span></span><br><span class="line"><span class="comment"># mysum = in_dec(*arg);</span></span><br><span class="line">my_sum = dec(my_sum)</span><br><span class="line">my_average = dec(my_average)</span><br><span class="line"></span><br><span class="line">print(my_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">print(my_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">'6'</span>))</span><br><span class="line"><span class="comment"># print(my_average(1, 2, 3, 4, 5))</span></span><br><span class="line"><span class="comment"># print(my_average())</span></span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(&apos;in dec arg=&apos;, (1, 2, 3, 4, 5))</span><br><span class="line">(&apos;in mysum arg=&apos;, (1, 2, 3, 4, 5))</span><br><span class="line">15</span><br><span class="line">(&apos;in dec arg=&apos;, (1, 2, 3, 4, 5, &apos;6&apos;))</span><br><span class="line">0</span><br></pre></td></tr></table></figure><p>我们把原有的重复的逻辑操作放进了我们的<code>in_dec</code>中。<br><code>def dec(func):</code>中<code>func</code>是我们传入的一个参数。因此我们调用这个函数时。我们可以指定它做什么</p><p>此时我们想要让<code>func()</code>对于<code>arg</code>进行处理。所以<code>return func(*arg)</code></p><p>函数名可以进行重新赋值：<code>my_sum = dec(my_sum)</code></p><ul><li>第一步我们调用的是<code>dec(func)</code>,调用之后将<code>my_sum</code>传了进去。因为在<code>in_dec</code>中我们对他进行了使用。所以我们的<code>in_dec</code>就是一个闭包。<ul><li>这个时候<code>my_sum</code>就已经作为<code>in_dec</code>的一个<code>__closure__</code> 属性被保存。那么在<code>in_dec</code>内部就可以直接使用<code>my_sum</code></li></ul></li><li>第二步<code>my_sum = dec(my_sum)</code>时。<code>my_sum</code>将保存<code>dec()</code>被调用后的返回值也就是<code>in_dec(*arg)</code>对象。</li></ul><p>具体执行函数：</p><ul><li>第一步是调用的<code>in_dec</code>函数</li><li>第二步是调用的<code>func</code>也就是<code>my_sum</code></li></ul><p>这里所有参数的处理都是<code>in_dec</code>处理的。所以当第二个直接返回<code>0</code>时，<code>my_sum</code>直接没有被调用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dec() return indec -&gt; my_sum;</span></span><br><span class="line"><span class="comment"># mysum = in_dec(*arg);</span></span><br></pre></td></tr></table></figure><h1 id="Python装饰器"><a href="#Python装饰器" class="headerlink" title="Python装饰器"></a>Python装饰器</h1><p>python装饰器</p><pre><code>- 装饰器用来装饰函数
- 返回一个函数对象
- 被装饰函数标识符指定返回的函数对象(A被装饰了，再用A接收被装饰后返会的新对象)被装饰的函数去哪了？
- 语法糖 @deco
</code></pre><p><code>my_sum = dec(my_sum)</code>执行过程：</p><ul><li><code>dec(my_sum)</code>将<code>my_sum</code>作为一个参数传给<code>dec</code>函数.</li><li><code>dec</code>函数内部有一个内置的函数<code>in_dec</code></li><li>内置函数作为返回值重新赋给了<code>my_sum</code></li></ul><p>理解：装饰器就是对于闭包的一个使用。Python提供了语法糖<code>@</code></p><p>实现代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"call dec"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">in_dec</span><span class="params">(*arg)</span>:</span>  <span class="comment"># my_sum</span></span><br><span class="line">        <span class="keyword">print</span> (<span class="string">'in dec arg='</span>, arg)</span><br><span class="line">        <span class="keyword">if</span> len(arg) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> val <span class="keyword">in</span> arg:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> isinstance(val, int):</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> func(*arg)</span><br><span class="line">    <span class="keyword">return</span> in_dec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dec</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_sum</span><span class="params">(*arg)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'in mysum arg='</span>, arg)</span><br><span class="line">    <span class="keyword">return</span> sum(arg)</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call dec</span><br></pre></td></tr></table></figure><p>并没有显式的调用任何方法，但是打印出了<code>call dec</code><br>因为<code>@dec</code>就相当于<code>my_sum = dec(my_sum)</code>已经进行了调用。此时的<code>my_sum</code>已经是装饰后的函数<code>in_dec</code>了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> (my_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">15</span><br></pre></td></tr></table></figure><p><code>@dec</code>就相当于<code>my_sum = dec(my_sum)</code>，这是python解释器支持的语法糖。</p><p>实现代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"call dec"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">in_dec</span><span class="params">(*arg)</span>:</span>  <span class="comment"># my_sum</span></span><br><span class="line"></span><br><span class="line">        print(<span class="string">'in dec arg='</span>, arg)</span><br><span class="line">        <span class="keyword">if</span> len(arg) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> val <span class="keyword">in</span> arg:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> isinstance(val, int):</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> func(*arg)</span><br><span class="line">    print(<span class="string">'return in_dec'</span>)</span><br><span class="line">    <span class="keyword">return</span> in_dec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dec</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_sum</span><span class="params">(*arg)</span>:</span>  <span class="comment"># my_sum = in_dec</span></span><br><span class="line">    print(<span class="string">'in mysum arg='</span>, arg)</span><br><span class="line">    <span class="keyword">return</span> sum(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(my_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">call dec</span><br><span class="line">return in_dec</span><br><span class="line">(&apos;in dec arg=&apos;, (1, 2, 3, 4, 5))</span><br><span class="line">(&apos;in mysum arg=&apos;, (1, 2, 3, 4, 5))</span><br><span class="line">15</span><br></pre></td></tr></table></figure><p>装饰器就是对于我们的函数进行了功能的丰富。内部继续调用具体函数，<br>将新函数返回，并覆盖原函数变量。实质就是对于闭包的使用。<br><code>my_sum</code>当做<code>enclosing</code>域的变量。被内置函数<code>in_dec</code>所使用。</p><p>实现代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deco</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">in_deco</span><span class="params">()</span>:</span></span><br><span class="line">        print(<span class="string">'in decp'</span>)</span><br><span class="line">        func()</span><br><span class="line">    print(<span class="string">'call deco'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@deco</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in bar'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> (type(bar))</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call deco</span><br><span class="line">&lt;type &apos;NoneType&apos;&gt;</span><br></pre></td></tr></table></figure><p>因为我们在外层函数<code>deco</code>中返回的是<code>None</code></p><p>实现代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deco</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">in_deco</span><span class="params">()</span>:</span></span><br><span class="line">        print(<span class="string">'in decp'</span>)</span><br><span class="line">        func()</span><br><span class="line">    print(<span class="string">'call deco'</span>)</span><br><span class="line">    <span class="keyword">return</span> in_deco</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@deco</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in bar'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(type(bar))</span><br><span class="line">bar()</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">call deco</span><br><span class="line">&lt;type &apos;function&apos;&gt;</span><br><span class="line">in decp</span><br><span class="line">in bar</span><br></pre></td></tr></table></figure><p>给被装饰函数加上参数：第二个装饰器。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@deco</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    print(<span class="string">'in bar'</span>, x + y)</span><br></pre></td></tr></table></figure><p>我们如果给被装饰函数加上了参数。那么也要对要返回的内置函数<code>in_deco</code>加上参数。<br>否则报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: bar() takes exactly 2 arguments (0 given)</span><br></pre></td></tr></table></figure><p>实现代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deco</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">in_deco</span><span class="params">(x, y)</span>:</span></span><br><span class="line">        print(<span class="string">'in decp'</span>)</span><br><span class="line">        func(x, y)</span><br><span class="line">    print(<span class="string">'call deco'</span>)</span><br><span class="line">    <span class="keyword">return</span> in_deco</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@deco</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    print(<span class="string">'in bar'</span>, x + y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(type(bar))</span><br><span class="line">bar(<span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">call deco</span><br><span class="line">&lt;type &apos;function&apos;&gt;</span><br><span class="line">in decp</span><br><span class="line">(&apos;in bar&apos;, 3)</span><br></pre></td></tr></table></figure><p>要同时对于<code>in_deco(x, y)</code>和<code>func(x, y)</code>都加上参数。</p><p>假设我们是Python解释器：</p><ul><li>我们看到了<code>@deco</code>我们将会调用<code>deco()</code>然后将<code>bar</code>也就是被装饰函数作为参数传入。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">deco(bar) -&gt; indeco</span><br><span class="line">bar -&gt; in_deco  #(enclosing作用域)变量保存在in_deco的`__closure__`使用。</span><br><span class="line">bar() in_deco() 重新调用自己属性中的被装饰函数</span><br></pre></td></tr></table></figure><ul><li>调用之后<code>deco</code>会返回一个<code>in_deco</code>的函数对象。</li><li>现在根本没地方选的。只能存在原来的<code>bar</code>中。因此<code>bar</code>已经变成了<code>in_deco</code></li><li>而<code>in_deco</code>中调用的<code>func(x,y)</code>是存放在自己的<code>bar.__closure__</code>中了。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deco</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">in_deco</span><span class="params">(x, y)</span>:</span></span><br><span class="line">        print(<span class="string">'%x'</span> % id(func))</span><br><span class="line">        print(in_deco.__closure__)</span><br><span class="line">        print(<span class="string">'in deco'</span>)</span><br><span class="line">        func(x, y)</span><br><span class="line">    print(<span class="string">'call deco'</span>)</span><br><span class="line">    <span class="keyword">return</span> in_deco</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@deco</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    print(<span class="string">'%x'</span> % id(bar))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bar(<span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">call deco</span><br><span class="line">5491ba8</span><br><span class="line">(&lt;cell at 0x0000000004F66F78: function object at 0x0000000005491BA8&gt;, &lt;cell at 0x000000000546EA38: function object at 0x0000000005491C18&gt;)</span><br><span class="line">in deco</span><br><span class="line">5491c18</span><br></pre></td></tr></table></figure><p>可以看出<code>in_deco.__closure__</code>已经将<code>原始bar函数</code>进行了保存。</p><p>这里就有一个问题了？可以看出里面保存着两个变量。(第一个是一个函数对象<code>func</code>，第二个便是我们的<code>原始bar</code>)</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/post/aaa76191.html">Python装饰器-专题笔记</a></p><p><span>文章作者:</span><a href="/" title="访问 mtianyan 的个人博客">mtianyan</a></p><p><span>发布时间:</span>2018年01月04日 - 16:01</p><p><span>最后更新:</span>2018年02月02日 - 20:02</p><p><span>原始链接:</span><a href="/post/aaa76191.html" title="Python装饰器-专题笔记">http://blog.mtianyan.cn/post/aaa76191.html</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://blog.mtianyan.cn/post/aaa76191.html" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>请博主吃包辣条</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/wechatpay.png" alt="mtianyan 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/alipay.jpg" alt="mtianyan 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a><a href="/tags/专题笔记/" rel="tag"><i class="fa fa-tag"></i> 专题笔记</a><a href="/tags/装饰器/" rel="tag"><i class="fa fa-tag"></i> 装饰器</a></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/post/1d8f9861.html" rel="next" title="Python进阶学习笔记"><i class="fa fa-chevron-left"></i> Python进阶学习笔记</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/post/90a759d5.html" rel="prev" title="用TravisCI持续集成自动部署Hexo博客的个人实践">用TravisCI持续集成自动部署Hexo博客的个人实践<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"> <span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2154292" charset="utf-8"></script></div></div></div><div class="comments" id="comments"><div id="SOHUCS"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="mtianyan"><p class="site-author-name" itemprop="name">mtianyan</p><p class="site-description motion-element" itemprop="description">爱分享，爱技术，爱生活。</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">37</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">23</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/mtianyan" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://www.jianshu.com/u/db9a7a0daa1f" target="_blank" title="简书"><i class="fa fa-fw fa-book"></i> 简书</a></span><span class="links-of-author-item"><a href="https://plus.google.com/u/0/114963812195952881148" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i> Google</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://mtianyan.gitee.io/" title="本站孪生站(国内码云托管)" target="_blank">本站孪生站(国内码云托管)</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#函数作用域"><span class="nav-number">1.</span> <span class="nav-text">函数作用域</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#什么是闭包"><span class="nav-number">2.</span> <span class="nav-text">什么是闭包</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#装饰器之闭包1"><span class="nav-number">2.1.</span> <span class="nav-text">装饰器之闭包1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#装饰器之闭包2"><span class="nav-number">2.2.</span> <span class="nav-text">装饰器之闭包2</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Python装饰器"><span class="nav-number">3.</span> <span class="nav-text">Python装饰器</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">mtianyan</span><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共182.8k字</span></div></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script> <span class="site-uv">本站访客数<span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人次</span> <span class="site-pv">本站总访问量<span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script><script type="text/javascript">!function(){var t="1eb79150519fd9b791c77e8eef6f3632";if((window.innerWidth||document.documentElement.clientWidth)<960)window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=cyrJmJ3rL&conf='+t+'"><\/script>');else{!function(t,e){var n=document.getElementsByTagName("head")[0]||document.head||document.documentElement,a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("charset","UTF-8"),a.setAttribute("src",t),"function"==typeof e&&(window.attachEvent?a.onreadystatechange=function(){var t=a.readyState;"loaded"!==t&&"complete"!==t||(a.onreadystatechange=null,e())}:a.onload=e),n.appendChild(a)}("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:"cyrJmJ3rL",conf:t})})}}()</script><script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script><script type="text/javascript">var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")};function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){var r=!1,s=0,a=0,i=n.title.trim(),c=i.toLowerCase(),l=n.content.trim().replace(/<[^>]+>/g,""),h=l.toLowerCase(),p=decodeURIComponent(n.url),u=[],f=[];if(""!=i&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}u=u.concat(e(t,c,!1)),f=f.concat(e(t,h,!1))}),(u.length>0||f.length>0)&&(r=!0,s=u.length+f.length)),r){[u,f].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});function d(e,o,n,r){for(var s=r[r.length-1],i=s.position,c=s.word,l=[],h=0;i+c.length<=n&&0!=r.length;){c===t&&h++,l.push({position:i,length:c.length});var p=i+c.length;for(r.pop();0!=r.length&&(i=(s=r[r.length-1]).position,c=s.word,p>i);)r.pop()}return a+=h,{hits:l,start:o,end:n,searchTextCount:h}}var g=[];0!=u.length&&g.push(d(0,0,i.length,u));for(var v=[];0!=f.length;){var $=f[f.length-1],C=$.position,m=$.word,x=C-20,w=C+80;x<0&&(x=0),w<C+m.length&&(w=C+m.length),w>l.length&&(w=l.length),v.push(d(0,x,w,f))}v.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var y=parseInt("1");y>=0&&(v=v.slice(0,y));function T(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var b="";0!=g.length?b+="<li><a href='"+p+"' class='search-result-title'>"+T(i,g[0])+"</a>":b+="<li><a href='"+p+"' class='search-result-title'>"+i+"</a>",v.forEach(function(t){b+="<a href='"+p+'\'><p class="search-result">'+T(l,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:a,hitCount:s,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("2uqmIjYredIvFy6tEXbKG4Fj-gzGzoHsz","CWl1rE8cQlIseOg2Cq3hzxYi")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var i=0;i<e.length;i++){var s=e[i],r=s.get("url"),l=s.get("time"),c=document.getElementById(r);$(c).find(t).text(l)}for(i=0;i<n.length;i++){r=n[i],c=document.getElementById(r);var u=$(c).find(t);""==u.text()&&u.text(0)}}else o.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var s=new e,r=new AV.ACL;r.setPublicReadAccess(!0),r.setPublicWriteAccess(!0),s.setACL(r),s.set("title",o),s.set("url",n),s.set("time",1),s.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={},pbOptions.iconStyle="default",pbOptions.boxForm="horizontal",pbOptions.position="bottomCenter",pbOptions.networks="Weibo,Wechat,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={},flOptions.iconStyle="default",flOptions.boxForm="horizontal",flOptions.position="middleRight",flOptions.networks="Weibo,Wechat,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-float",flOptions)</script><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script><script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><div id="hexo-helper-live2d"><canvas id="live2dcanvas" width="150" height="300"></canvas></div><style>#live2dcanvas{position:fixed;width:150px;height:300px;opacity:.7;right:-30px;z-index:999;pointer-events:none;bottom:40px}</style><script type="text/javascript" src="/live2d/device.min.js"></script><script type="text/javascript">
const loadScript = function loadScript(c,b){var a=document.createElement("script");a.type="text/javascript";"undefined"!=typeof b&&(a.readyState?a.onreadystatechange=function(){if("loaded"==a.readyState||"complete"==a.readyState)a.onreadystatechange=null,b()}:a.onload=function(){b()});a.src=c;document.body.appendChild(a)};
(function(){
  if((typeof(device) != 'undefined') && (device.mobile())){
    var trElement = document.getElementById('hexo-helper-live2d');
    trElement.parentNode.removeChild(trElement);
    return;
  }else
    if (typeof(device) === 'undefined') console.error('Cannot find current-device script.');
  loadScript("/live2d/script.js", function(){loadlive2d("live2dcanvas", "/live2d/assets/hijiki.model.json", 0.5);});
})();
</script></body></html><script type="text/javascript" src="/js/src/love.js"></script>